<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Guide: Staged Patient Matching and Time-based Episode Grouping with EpiDM • epidm</title>
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Guide: Staged Patient Matching and Time-based Episode Grouping with EpiDM">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">epidm</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.6</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/epidm-function-usage.html">Guide: Staged Patient Matching and Time-based Episode Grouping with EpiDM</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ukhsa-collaboration/epidm/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Guide: Staged Patient Matching and Time-based Episode Grouping with EpiDM</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ukhsa-collaboration/epidm/blob/master/vignettes/epidm-function-usage.Rmd" class="external-link"><code>vignettes/epidm-function-usage.Rmd</code></a></small>
      <div class="d-none name"><code>epidm-function-usage.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <strong>epidm</strong> R package provides utilities to support
patient identity resolution and clinical episode construction.</p>
<p>This vignette introduces two key functions:</p>
<ol style="list-style-type: decimal">
<li><p><strong><code><a href="../reference/uk_patient_id.html">uk_patient_id()</a></code></strong><br>
Identifying patients and generating unique patient ids using known
patient identifiers with multiple staged rules.</p></li>
<li><p><strong><code><a href="../reference/group_time.html">group_time()</a></code></strong><br>
Groups time intervals into clinically meaningful episodes (static or
rolling windows).</p></li>
</ol>
<p>Both functions are designed for <strong>healthcare data</strong>, for
example SGSS, HES/SUS data and ECDS data where repeated records across
systems must be linked or aggregated.</p>
</div>
<div class="section level2">
<h2 id="uk_patient_id-function">1. <code>uk_patient_id()</code> function<a class="anchor" aria-label="anchor" href="#uk_patient_id-function"></a>
</h2>
<div class="section level3">
<h3 id="input-requirements">Input Requirements<a class="anchor" aria-label="anchor" href="#input-requirements"></a>
</h3>
<p>A dataset should ideally contain:</p>
<ul>
<li>NHS number</li>
<li>Hospital number</li>
<li>Date of birth</li>
<li>Sex</li>
<li>Forename</li>
<li>Surname</li>
<li>Postcode</li>
</ul>
<p>You must also supply a <strong>list mapping your column
names</strong> using the <code>id = list(...)</code> argument.</p>
</div>
<div class="section level3">
<h3 id="example-usage">Example usage<a class="anchor" aria-label="anchor" href="#example-usage"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1) Create example data</span></span>
<span><span class="va">id_test</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    record_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1L</span>,<span class="fl">2L</span>,<span class="fl">3L</span>,<span class="fl">4L</span>,</span>
<span>                  <span class="fl">5L</span>,<span class="fl">6L</span>,<span class="fl">7L</span>,<span class="fl">8L</span>,<span class="fl">9L</span>,<span class="fl">10L</span>,<span class="fl">11L</span>,<span class="fl">12L</span>,<span class="fl">13L</span>,<span class="fl">14L</span>,<span class="fl">15L</span>,</span>
<span>                  <span class="fl">16L</span>,<span class="fl">17L</span>,<span class="fl">18L</span>,<span class="fl">19L</span>,<span class="fl">20L</span>,<span class="fl">21L</span>,<span class="fl">22L</span>,<span class="fl">23L</span>,<span class="fl">24L</span><span class="op">)</span>,</span>
<span>    nhs_number <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">9435754422</span>,</span>
<span>                   <span class="fl">9435754422</span>,<span class="cn">NA</span>,<span class="fl">9435754422</span>,<span class="fl">5555555555</span>,<span class="cn">NA</span>,</span>
<span>                   <span class="fl">9435773982</span>,<span class="cn">NA</span>,<span class="fl">9999999999</span>,<span class="cn">NA</span>,<span class="fl">9435773982</span>,<span class="cn">NA</span>,</span>
<span>                   <span class="fl">9435802508</span>,<span class="fl">9435802508</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="fl">9435802508</span>,<span class="fl">9435802508</span>,<span class="cn">NA</span>,</span>
<span>                   <span class="fl">3333333333</span>,<span class="cn">NA</span>,<span class="fl">9999999999</span>,<span class="fl">9435817777</span>,</span>
<span>                   <span class="fl">9435817777</span><span class="op">)</span>,</span>
<span>    local_patient_identifier <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="st">"IG12067"</span>,</span>
<span>                                 <span class="cn">NA</span>,<span class="cn">NA</span>,<span class="st">"IG12067"</span>,<span class="st">"IG12067"</span>,<span class="st">"KR2535"</span>,<span class="st">"KR2535"</span>,</span>
<span>                                 <span class="st">"KR2535"</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="st">"UK8734"</span>,<span class="st">"UK8734"</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,</span>
<span>                                 <span class="st">"UK8734"</span>,<span class="st">"UK8734"</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="st">"JH45204"</span>,</span>
<span>                                 <span class="st">"HS45202"</span>,<span class="st">"HS45202"</span>,<span class="st">"JH45204"</span><span class="op">)</span>,</span>
<span>    patient_birth_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"1993-07-16"</span>,</span>
<span>                           <span class="st">"1993-07-16"</span>,<span class="st">"1993-07-16"</span>,<span class="st">"1993-07-16"</span>,</span>
<span>                           <span class="st">"1993-07-16"</span>,<span class="cn">NA</span>,<span class="st">"1967-02-10"</span>,<span class="cn">NA</span>,<span class="st">"1967-02-10"</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,</span>
<span>                           <span class="st">"1967-02-10"</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="st">"1952-10-22"</span>,<span class="st">"1952-10-22"</span>,</span>
<span>                           <span class="st">"1952-10-22"</span>,<span class="cn">NA</span>,<span class="st">"1947-09-14"</span>,<span class="st">"1947-09-14"</span>,</span>
<span>                           <span class="st">"1947-09-14"</span>,<span class="st">"1947-09-14"</span>,<span class="st">"1947-09-14"</span>,</span>
<span>                           <span class="st">"1947-09-14"</span><span class="op">)</span>,</span>
<span>    sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Male"</span>,<span class="st">"Male"</span>,</span>
<span>            <span class="st">"Male"</span>,<span class="st">"Male"</span>,<span class="cn">NA</span>,<span class="st">"Male"</span>,<span class="st">"Female"</span>,<span class="st">"Female"</span>,</span>
<span>            <span class="st">"Female"</span>,<span class="st">"Female"</span>,<span class="st">"Female"</span>,<span class="st">"Female"</span>,<span class="st">"Male"</span>,</span>
<span>            <span class="st">"Male"</span>,<span class="st">"Male"</span>,<span class="st">"Male"</span>,<span class="st">"Male"</span>,<span class="st">"Male"</span>,<span class="st">"Male"</span>,</span>
<span>            <span class="st">"Male"</span>,<span class="st">"Male"</span>,<span class="st">"Male"</span>,<span class="cn">NA</span>,<span class="st">"Male"</span><span class="op">)</span>,</span>
<span>    forename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="st">"DENNIS"</span>,</span>
<span>                 <span class="cn">NA</span>,<span class="cn">NA</span>,<span class="st">"DENNIS"</span>,<span class="cn">NA</span>,<span class="st">"ELLIE"</span>,<span class="st">"ELLIE"</span>,<span class="cn">NA</span>,</span>
<span>                 <span class="st">"ELLIE"</span>,<span class="st">"ELLIE"</span>,<span class="st">"ELLIE"</span>,<span class="st">"IAN"</span>,<span class="st">"IAN"</span>,<span class="st">"MALCOLM"</span>,</span>
<span>                 <span class="st">"IAN"</span>,<span class="st">"IAN"</span>,<span class="cn">NA</span>,<span class="st">"GRANT"</span>,<span class="st">"ALAN"</span>,<span class="st">"ALAN"</span>,<span class="st">"ALAN"</span>,</span>
<span>                 <span class="st">"GRANT"</span>,<span class="st">"ALAN"</span><span class="op">)</span>,</span>
<span>    surname <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="st">"NEDRY"</span>,</span>
<span>                <span class="st">"NEDRY"</span>,<span class="cn">NA</span>,<span class="st">"NEDRY"</span>,<span class="st">"NEDRY"</span>,<span class="st">"SATTLER"</span>,<span class="st">"SATTLER"</span>,</span>
<span>                <span class="cn">NA</span>,<span class="st">"SATTLER"</span>,<span class="st">"SATTLER"</span>,<span class="st">"SATTLER"</span>,<span class="st">"M"</span>,<span class="cn">NA</span>,</span>
<span>                <span class="st">"IAN"</span>,<span class="st">"MALCOLM"</span>,<span class="st">"MALCOLM"</span>,<span class="cn">NA</span>,<span class="st">"ALAN"</span>,<span class="st">"GRANT"</span>,</span>
<span>                <span class="st">"GRANT"</span>,<span class="st">"GRANT"</span>,<span class="st">"ALAN"</span>,<span class="st">"GRANT"</span><span class="op">)</span>,</span>
<span>    postcode <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HA4 0FF"</span>,</span>
<span>                 <span class="st">"HA4 0FF"</span>,<span class="st">"HA4 0FF"</span>,<span class="cn">NA</span>,<span class="st">"HA4 0FF"</span>,<span class="st">"HA4 0FF"</span>,</span>
<span>                 <span class="st">"L3 1DZ"</span>,<span class="st">"L3 1DZ"</span>,<span class="st">"L3 1DZ"</span>,<span class="st">"L3 1DZ"</span>,<span class="cn">NA</span>,<span class="st">"L3 1DZ"</span>,</span>
<span>                 <span class="st">"BN14 9EP"</span>,<span class="cn">NA</span>,<span class="st">"BN14 9EP"</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="st">"CW6 9TX"</span>,</span>
<span>                 <span class="st">"CW6 9TX"</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span><span class="op">)</span>,</span>
<span>    specimen_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"2024-08-14"</span>,</span>
<span>                      <span class="st">"2023-02-03"</span>,<span class="st">"2023-02-07"</span>,<span class="st">"2023-02-04"</span>,</span>
<span>                      <span class="st">"2023-02-09"</span>,<span class="st">"2024-08-14"</span>,<span class="st">"2021-03-28"</span>,<span class="st">"2021-03-28"</span>,</span>
<span>                      <span class="st">"2021-03-28"</span>,<span class="st">"2021-03-28"</span>,<span class="st">"2021-03-28"</span>,</span>
<span>                      <span class="st">"2021-03-28"</span>,<span class="st">"2024-07-06"</span>,<span class="st">"2024-07-06"</span>,<span class="st">"2024-07-06"</span>,</span>
<span>                      <span class="st">"2023-10-31"</span>,<span class="st">"2023-10-31"</span>,<span class="st">"2023-10-31"</span>,</span>
<span>                      <span class="st">"2022-01-23"</span>,<span class="st">"2022-01-24"</span>,<span class="st">"2022-01-25"</span>,<span class="st">"2022-01-26"</span>,</span>
<span>                      <span class="st">"2022-01-27"</span>,<span class="st">"2022-01-28"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># 2) Run uk_patient_id()</span></span>
<span><span class="va">result_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/uk_patient_id.html">uk_patient_id</a></span><span class="op">(</span></span>
<span>  <span class="va">id_test</span>,</span>
<span>  id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    nhs_number    <span class="op">=</span> <span class="st">'nhs_number'</span>,</span>
<span>    hospital_number <span class="op">=</span> <span class="st">'local_patient_identifier'</span>,</span>
<span>    date_of_birth <span class="op">=</span> <span class="st">'patient_birth_date'</span>,</span>
<span>    sex_mfu       <span class="op">=</span> <span class="st">'sex'</span>,</span>
<span>    forename      <span class="op">=</span> <span class="st">'forename'</span>,</span>
<span>    surname       <span class="op">=</span> <span class="st">'surname'</span>,</span>
<span>    postcode      <span class="op">=</span> <span class="st">'postcode'</span></span>
<span>  <span class="op">)</span>,</span>
<span>  .useStages   <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">11</span>,      <span class="co"># optional</span></span>
<span>  .keepStages  <span class="op">=</span> <span class="cn">FALSE</span>,     <span class="co"># optional</span></span>
<span>  .keepValidNHS <span class="op">=</span> <span class="cn">FALSE</span>     <span class="co"># optional</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3) Show a preview</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">result_id</span><span class="op">)</span>, row.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt;     id record_id nhs_number local_patient_identifier patient_birth_date    sex</span></span>
<span><span class="co">#&gt;  &lt;int&gt;     &lt;int&gt;     &lt;char&gt;                   &lt;char&gt;             &lt;char&gt; &lt;char&gt;</span></span>
<span><span class="co">#&gt;      1         1 9435754422                     &lt;NA&gt;         1993-07-16      M</span></span>
<span><span class="co">#&gt;      1         2 9435754422                  IG12067         1993-07-16      M</span></span>
<span><span class="co">#&gt;      1         3       &lt;NA&gt;                     &lt;NA&gt;         1993-07-16      M</span></span>
<span><span class="co">#&gt;      1         4 9435754422                     &lt;NA&gt;         1993-07-16      M</span></span>
<span><span class="co">#&gt;      1         5 5555555555                  IG12067         1993-07-16   &lt;NA&gt;</span></span>
<span><span class="co">#&gt;      1         6       &lt;NA&gt;                  IG12067               &lt;NA&gt;      M</span></span>
<span><span class="co">#&gt;  forename surname postcode specimen_date</span></span>
<span><span class="co">#&gt;    &lt;char&gt;  &lt;char&gt;   &lt;char&gt;        &lt;char&gt;</span></span>
<span><span class="co">#&gt;      &lt;NA&gt;    &lt;NA&gt;   HA40FF    2024-08-14</span></span>
<span><span class="co">#&gt;    DENNIS   NEDRY   HA40FF    2023-02-03</span></span>
<span><span class="co">#&gt;      &lt;NA&gt;   NEDRY   HA40FF    2023-02-07</span></span>
<span><span class="co">#&gt;      &lt;NA&gt;    &lt;NA&gt;     &lt;NA&gt;    2023-02-04</span></span>
<span><span class="co">#&gt;    DENNIS   NEDRY   HA40FF    2023-02-09</span></span>
<span><span class="co">#&gt;      &lt;NA&gt;   NEDRY   HA40FF    2024-08-14</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="group_time-function">2. <code>group_time()</code> function<a class="anchor" aria-label="anchor" href="#group_time-function"></a>
</h2>
<div class="section level3">
<h3 id="input-requirements-1">Input Requirements<a class="anchor" aria-label="anchor" href="#input-requirements-1"></a>
</h3>
<p>A dataset should ideally contain:</p>
<ul>
<li>One or more grouping variables (e.g., patient ID, organism, specimen
type)</li>
<li>A start date column (date_start)</li>
<li>For intervals: an end date column (date_end)</li>
<li>For events: a window (integer, days) and window_type (“static” or
“rolling”)</li>
</ul>
<p>You must also supply the grouping and date arguments via function
parameters:</p>
<ul>
<li>group_vars (character vector of column names)</li>
<li>date_start</li>
<li>Plus either date_end (for intervals) or window + window_type (for
events)</li>
<li>Optional: indx_varname, min_varname, max_varname to control output
column names</li>
</ul>
</div>
<div class="section level3">
<h3 id="purpose">Purpose<a class="anchor" aria-label="anchor" href="#purpose"></a>
</h3>
<p><code><a href="../reference/group_time.html">group_time()</a></code> aggregates:</p>
<ul>
<li><p><strong>Intervals</strong> (start + end dates)<br>
e.g., hospital spells (HES/SUS)</p></li>
<li><p><strong>Events</strong> (single date)<br>
e.g., microbiology specimen dates</p></li>
</ul>
<p>Two episode rules are supported:</p>
<table class="table">
<colgroup>
<col width="40%">
<col width="60%">
</colgroup>
<thead><tr class="header">
<th>Type</th>
<th>Meaning</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><strong>Static window</strong></td>
<td>Based on the first event only; all events within X days of the
<strong>first</strong> event belong to the same episode.</td>
</tr>
<tr class="even">
<td><strong>Rolling window</strong></td>
<td>The window resets with each event; a new event inside X days of the
<strong>previous</strong> event extends the episode.</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="example-usage-1">Example usage<a class="anchor" aria-label="anchor" href="#example-usage-1"></a>
</h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Events example (14‑day static window):</span></span>
<span><span class="co">#1) Create example data</span></span>
<span></span>
<span><span class="va">episode_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    pat_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">1L</span>, <span class="fl">1L</span>, <span class="fl">1L</span>, <span class="fl">2L</span>, <span class="fl">2L</span>, <span class="fl">2L</span>, <span class="fl">1L</span>, <span class="fl">1L</span>, <span class="fl">1L</span>, <span class="fl">1L</span>, <span class="fl">2L</span>, <span class="fl">2L</span>, <span class="fl">2L</span><span class="op">)</span>,</span>
<span>    species <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"E. coli"</span>, <span class="fl">7</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"K. pneumonia"</span>, <span class="fl">7</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    spec_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"Blood"</span>, <span class="fl">7</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"Blood"</span>, <span class="fl">4</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"Sputum"</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    sp_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>        <span class="fl">18262</span>,</span>
<span>        <span class="fl">18263</span>,</span>
<span>        <span class="fl">18281</span>,</span>
<span>        <span class="fl">18282</span>,</span>
<span>        <span class="fl">18262</span>,</span>
<span>        <span class="fl">18263</span>,</span>
<span>        <span class="fl">18281</span>,</span>
<span>        <span class="fl">18265</span>,</span>
<span>        <span class="fl">18270</span>,</span>
<span>        <span class="fl">18281</span>,</span>
<span>        <span class="fl">18283</span>,</span>
<span>        <span class="fl">18259</span>,</span>
<span>        <span class="fl">18260</span>,</span>
<span>        <span class="fl">18281</span></span>
<span>      <span class="op">)</span>,</span>
<span>      class <span class="op">=</span> <span class="st">"Date"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  row.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="op">-</span><span class="fl">14L</span><span class="op">)</span>,</span>
<span>  class <span class="op">=</span> <span class="st">"data.frame"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2) Run group_time() for events using a 14-day static window</span></span>
<span><span class="va">ep_static</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/group_time.html">group_time</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">episode_test</span>,</span>
<span>  date_start <span class="op">=</span> <span class="st">'sp_date'</span>,</span>
<span>  window <span class="op">=</span> <span class="fl">14</span>,</span>
<span>  window_type <span class="op">=</span> <span class="st">'static'</span>,</span>
<span>  group_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'pat_id'</span>, <span class="st">'species'</span>, <span class="st">'spec_type'</span><span class="op">)</span>,</span>
<span>  indx_varname <span class="op">=</span> <span class="st">'static_indx'</span>,   <span class="co"># optional</span></span>
<span>  min_varname <span class="op">=</span> <span class="st">'min_date'</span>,</span>
<span>  <span class="co"># optional (defaults)</span></span>
<span>  max_varname <span class="op">=</span> <span class="st">'max_date'</span>      <span class="co"># optional (defaults)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># 3) Show a preview</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">ep_static</span><span class="op">)</span>, row.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt;  pat_id      species spec_type    sp_date static_indx   min_date   max_date</span></span>
<span><span class="co">#&gt;   &lt;int&gt;       &lt;char&gt;    &lt;char&gt;     &lt;Date&gt;      &lt;char&gt;     &lt;Date&gt;     &lt;Date&gt;</span></span>
<span><span class="co">#&gt;       1      E. coli     Blood 2020-01-01       1.4.1 2020-01-01 2020-01-02</span></span>
<span><span class="co">#&gt;       1      E. coli     Blood 2020-01-02       1.4.1 2020-01-01 2020-01-02</span></span>
<span><span class="co">#&gt;       1      E. coli     Blood 2020-01-20       1.4.2 2020-01-20 2020-01-21</span></span>
<span><span class="co">#&gt;       1      E. coli     Blood 2020-01-21       1.4.2 2020-01-20 2020-01-21</span></span>
<span><span class="co">#&gt;       1 K. pneumonia     Blood 2020-01-04       2.4.1 2020-01-04 2020-01-09</span></span>
<span><span class="co">#&gt;       1 K. pneumonia     Blood 2020-01-09       2.4.1 2020-01-04 2020-01-09</span></span>
<span></span>
<span></span>
<span><span class="co"># Intervals example (start + end dates):1) Create example interval data (start + end dates)</span></span>
<span><span class="co">#1) Create example data</span></span>
<span><span class="va">spell_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">99</span>, <span class="fl">6</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">88</span>, <span class="fl">4</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  provider <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"YXZ"</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"ZXY"</span>, <span class="fl">5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"XYZ"</span>, <span class="fl">4</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"YZX"</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  spell_start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"2020-03-01"</span>,</span>
<span>      <span class="st">"2020-07-07"</span>,</span>
<span>      <span class="st">"2020-02-08"</span>,</span>
<span>      <span class="st">"2020-04-28"</span>,</span>
<span>      <span class="st">"2020-03-15"</span>,</span>
<span>      <span class="st">"2020-07-01"</span>,</span>
<span>      <span class="st">"2020-01-01"</span>,</span>
<span>      <span class="st">"2020-01-12"</span>,</span>
<span>      <span class="st">"2019-12-25"</span>,</span>
<span>      <span class="st">"2020-03-28"</span>,</span>
<span>      <span class="st">"2020-01-01"</span>,</span>
<span>      <span class="cn">NA</span>,</span>
<span>      <span class="cn">NA</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  spell_end <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"2020-03-10"</span>,</span>
<span>      <span class="st">"2020-07-26"</span>,</span>
<span>      <span class="st">"2020-05-22"</span>,</span>
<span>      <span class="st">"2020-04-30"</span>,</span>
<span>      <span class="st">"2020-05-20"</span>,</span>
<span>      <span class="st">"2020-07-08"</span>,</span>
<span>      <span class="st">"2020-01-23"</span>,</span>
<span>      <span class="st">"2020-03-30"</span>,</span>
<span>      <span class="st">"2020-01-02"</span>,</span>
<span>      <span class="st">"2020-04-20"</span>,</span>
<span>      <span class="st">"2020-01-01"</span>,</span>
<span>      <span class="cn">NA</span>,</span>
<span>      <span class="cn">NA</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2) Run group_time() for intervals (start + end dates)</span></span>
<span><span class="va">spell_episodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/group_time.html">group_time</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">spell_test</span>,</span>
<span>  date_start <span class="op">=</span> <span class="st">'spell_start'</span>,</span>
<span>  date_end <span class="op">=</span> <span class="st">'spell_end'</span>,</span>
<span>  group_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'id'</span>, <span class="st">'provider'</span><span class="op">)</span>,</span>
<span>  indx_varname <span class="op">=</span> <span class="st">'spell_id'</span>,</span>
<span>  <span class="co"># optional</span></span>
<span>  min_varname <span class="op">=</span> <span class="st">'spell_min_date'</span>,</span>
<span>  <span class="co"># optional</span></span>
<span>  max_varname <span class="op">=</span> <span class="st">'spell_max_date'</span>        <span class="co"># optional</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3) Show a preview</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">spell_episodes</span><span class="op">)</span>, row.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt;     id provider spell_start  spell_end spell_id spell_min_date spell_max_date</span></span>
<span><span class="co">#&gt;  &lt;num&gt;   &lt;char&gt;      &lt;Date&gt;     &lt;Date&gt;   &lt;char&gt;         &lt;Date&gt;         &lt;Date&gt;</span></span>
<span><span class="co">#&gt;     88      XYZ  2019-12-25 2020-01-02    1.4.0     2019-12-25     2020-04-20</span></span>
<span><span class="co">#&gt;     88      XYZ  2020-01-01 2020-01-23    1.4.0     2019-12-25     2020-04-20</span></span>
<span><span class="co">#&gt;      3      YZX  2020-01-01 2020-01-01    2.1.0     2020-01-01     2020-01-01</span></span>
<span><span class="co">#&gt;     88      XYZ  2020-01-12 2020-03-30    1.4.0     2019-12-25     2020-04-20</span></span>
<span><span class="co">#&gt;     99      ZXY  2020-02-08 2020-05-22    3.5.0     2020-02-08     2020-05-22</span></span>
<span><span class="co">#&gt;     99      YXZ  2020-03-01 2020-03-10    4.1.0     2020-03-01     2020-03-10</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="using-uk_patient_id-and-group_time-together-with-sgss-and-cims-data">Using <strong>uk_patient_id()</strong> and
<strong>group_time()</strong> together with SGSS and CIMS data<a class="anchor" aria-label="anchor" href="#using-uk_patient_id-and-group_time-together-with-sgss-and-cims-data"></a>
</h2>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Example data generation</span></span>
<span></span>
<span><span class="co"># Helper to make plausible 10-digit NHS-like strings</span></span>
<span><span class="va">mk_nhs</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">9</span>, <span class="va">n</span> <span class="op">*</span> <span class="fl">10</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">n</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>        <span class="fl">1</span>, <span class="va">paste0</span>, collapse <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># A small "people" frame to borrow shared attributes from</span></span>
<span><span class="va">persons</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  id_person     <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">6</span>,</span>
<span>  nhsnumber     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu">mk_nhs</span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>, <span class="cn">NA_character_</span><span class="op">)</span>,   <span class="co"># include one missing NHS</span></span>
<span>  forename      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"John"</span>, <span class="st">"Jane"</span>, <span class="st">"Sam"</span>, <span class="st">"Aisha"</span>, <span class="st">"Maya"</span>, <span class="st">"John"</span><span class="op">)</span>,</span>
<span>  surname       <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Smith"</span>, <span class="st">"Doe"</span>, <span class="st">"Patel"</span>, <span class="st">"Khan"</span>, <span class="st">"Brown"</span>, <span class="st">"Smyth"</span><span class="op">)</span>,  <span class="co"># one spelling variant</span></span>
<span>  date_of_birth <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"1980-03-14"</span>,<span class="st">"1991-11-02"</span>,<span class="st">"1985-07-28"</span>,<span class="st">"2002-01-09"</span>,<span class="st">"2010-05-30"</span>,<span class="st">"1980-03-14"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  sex           <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"M"</span>,<span class="st">"F"</span>,<span class="st">"M"</span>,<span class="st">"F"</span>,<span class="st">"U"</span>,<span class="st">"M"</span><span class="op">)</span>,</span>
<span>  postcode      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SW1A 1AA"</span>,<span class="st">"E1 6AN"</span>,<span class="st">"B1 1AA"</span>,<span class="st">"M1 1AE"</span>,<span class="st">"CF10 1EP"</span>,<span class="st">"SW1A1AA"</span><span class="op">)</span> <span class="co"># one without space</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># --- SGSS-like data: multiple specimens per person, some within 30 days ------</span></span>
<span><span class="va">sgss_data</span> <span class="op">&lt;-</span> <span class="va">persons</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># duplicate person 1 (two specimens), and include others</span></span>
<span>  <span class="fu">slice</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">5</span>, <span class="fl">6</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    CDR_OPIE_ID            <span class="op">=</span> <span class="fu">row_number</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1000L</span>,</span>
<span>    earliest_specimen_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2023-10-01"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span>, <span class="fl">5</span>, <span class="fl">15</span>, <span class="fl">40</span>, <span class="fl">3</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    GROUP_A_STREP_PCR      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Detected"</span>,<span class="st">"Not detected"</span>,<span class="st">"Detected"</span>,<span class="st">"Detected"</span>,<span class="st">"Not detected"</span>,<span class="st">"Detected"</span>,<span class="st">"Detected"</span><span class="op">)</span>,</span>
<span>    third                  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"emm1"</span>,<span class="st">"emm1"</span>,<span class="st">"emm3"</span>,<span class="st">"emm12"</span>,<span class="st">""</span>,<span class="cn">NA</span>,<span class="st">"emm89"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span></span>
<span>    <span class="va">CDR_OPIE_ID</span>, <span class="va">nhsnumber</span>, <span class="va">forename</span>, <span class="va">surname</span>, <span class="va">date_of_birth</span>, <span class="va">sex</span>,</span>
<span>    <span class="va">postcode</span>, <span class="va">earliest_specimen_date</span>, <span class="va">GROUP_A_STREP_PCR</span>, <span class="va">third</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># --- CIMS-like data: case notifications, some within 30 days of SGSS ----------</span></span>
<span><span class="va">cims_data</span> <span class="op">&lt;-</span> <span class="va">persons</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># person 3 appears twice, person 1 appears once etc.</span></span>
<span>  <span class="fu">slice</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">6</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    Case_identifier <span class="op">=</span> <span class="fu">row_number</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fl">2000L</span>,</span>
<span>    Date_entered    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2023-10-05"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,  <span class="fl">6</span>,  <span class="fl">18</span>,  <span class="fl">50</span>,  <span class="fl">35</span>,  <span class="fl">1</span><span class="op">)</span>,</span>
<span>    Infection       <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"iGAS"</span>,<span class="st">"Scarlet fever"</span>,<span class="st">"iGAS"</span>,<span class="st">"iGAS"</span>,<span class="st">"Scarlet fever"</span>,<span class="st">"iGAS"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span></span>
<span>    <span class="va">Case_identifier</span>, <span class="va">nhsnumber</span>, <span class="va">forename</span>, <span class="va">surname</span>, <span class="va">date_of_birth</span>,</span>
<span>    <span class="va">sex</span>, <span class="va">postcode</span>, <span class="va">Date_entered</span>, <span class="va">Infection</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Example start:</span></span>
<span></span>
<span><span class="co"># Example of importing SGSS and CIMS data ready for linkage</span></span>
<span><span class="va">lnk.data_sgss</span> <span class="op">&lt;-</span> <span class="va">sgss_data</span></span>
<span><span class="va">lnk.data_cims</span> <span class="op">&lt;-</span> <span class="va">cims_data</span></span>
<span></span>
<span><span class="co"># Update SGSS column classes so they match with CIMS</span></span>
<span><span class="va">lnk.data_sgss</span> <span class="op">&lt;-</span> <span class="va">lnk.data_sgss</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    date_of_birth <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">date_of_birth</span><span class="op">)</span>,</span>
<span>    forename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">forename</span><span class="op">)</span>,</span>
<span>    surname <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">surname</span><span class="op">)</span>,</span>
<span>    postcode <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">postcode</span><span class="op">)</span>,</span>
<span>    patient_demog_sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">sex</span><span class="op">)</span>,</span>
<span>    earliest_specimen_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">earliest_specimen_date</span><span class="op">)</span>,</span>
<span>    nhsnumber <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">nhsnumber</span><span class="op">)</span></span>
<span>  <span class="op">)</span> </span>
<span></span>
<span><span class="co"># Update CIMS column classes so they match SGSS</span></span>
<span><span class="va">lnk.data_cims</span> <span class="op">&lt;-</span> <span class="va">lnk.data_cims</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    date_of_birth <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">date_of_birth</span><span class="op">)</span>,</span>
<span>    forename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">forename</span><span class="op">)</span>,</span>
<span>    surname <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">surname</span><span class="op">)</span>,</span>
<span>    postcode <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">postcode</span><span class="op">)</span>,</span>
<span>    sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">sex</span><span class="op">)</span>,</span>
<span>    Date_entered <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">Date_entered</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert data.frame to data.table so can be fed into function</span></span>
<span><span class="va">lnk.dt_cims</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/setDT.html" class="external-link">setDT</a></span><span class="op">(</span><span class="va">lnk.data_cims</span><span class="op">)</span></span>
<span><span class="va">lnk.dt_sgss</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/setDT.html" class="external-link">setDT</a></span><span class="op">(</span><span class="va">lnk.data_sgss</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Stack the two data sets</span></span>
<span><span class="va">lnk.dt_combined</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">bind_rows</span><span class="op">(</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span><span class="va">lnk.dt_cims</span>, data_source <span class="op">=</span> <span class="st">"dt_cims"</span><span class="op">)</span>,</span>
<span>    <span class="fu">mutate</span><span class="op">(</span><span class="va">lnk.dt_sgss</span>, data_source <span class="op">=</span> <span class="st">"dt_sgss"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Add common date field to be used during deduplication</span></span>
<span><span class="va">lnk.dt_combined</span> <span class="op">&lt;-</span> <span class="va">lnk.dt_combined</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>common_date <span class="op">=</span> <span class="op">(</span><span class="fu">coalesce</span><span class="op">(</span><span class="va">earliest_specimen_date</span>, <span class="va">Date_entered</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># List of id fields to be used during normalisation of id fields</span></span>
<span><span class="co"># This is a parameter that is fed into the uk_patient_id() function</span></span>
<span><span class="va">id</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  nhs_number <span class="op">=</span> <span class="st">'nhsnumber'</span>,</span>
<span>  date_of_birth <span class="op">=</span> <span class="st">'date_of_birth'</span>,</span>
<span>  sex_mfu <span class="op">=</span> <span class="st">'sex'</span>,</span>
<span>  forename <span class="op">=</span> <span class="st">'forename'</span>,</span>
<span>  surname <span class="op">=</span> <span class="st">'surname'</span>,</span>
<span>  postcode <span class="op">=</span> <span class="st">'postcode'</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Feeding combined SGSS and CIMS data into uk_patient_id() function to get </span></span>
<span><span class="co"># unique patient identifiers</span></span>
<span><span class="va">lnk.dt_combined_norm</span> <span class="op">&lt;-</span> <span class="fu">epidm</span><span class="fu">::</span><span class="fu"><a href="../reference/uk_patient_id.html">uk_patient_id</a></span><span class="op">(</span></span>
<span>  <span class="va">lnk.dt_combined</span>,</span>
<span>  <span class="va">id</span>,</span>
<span>  .useStages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span>,</span>
<span>  .sortOrder <span class="op">=</span> <span class="st">'common_date'</span>,</span>
<span>  .forceCopy <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  .keepValidNHS <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>  .keepStages <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in .f(.x[[i]], ...): NHS number is missing or empty</span></span>
<span><span class="co">#&gt; Warning in .f(.x[[i]], ...): NHS number is missing or empty</span></span>
<span></span>
<span><span class="co"># Group records by `id` into rolling 30-day windows based on `common_date`,</span></span>
<span><span class="co"># using `dedupe_key` as the unique row index; the trailing [] forces evaluation and returns a data.table</span></span>
<span><span class="va">lnk.dt_combined_grouped</span> <span class="op">&lt;-</span> <span class="fu">epidm</span><span class="fu">::</span><span class="fu"><a href="../reference/group_time.html">group_time</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">lnk.dt_combined_norm</span>,</span>
<span>  date_start <span class="op">=</span> <span class="st">'common_date'</span>,</span>
<span>  window <span class="op">=</span> <span class="fl">30</span>,</span>
<span>  window_type <span class="op">=</span> <span class="st">'rolling'</span>,</span>
<span>  indx_varname <span class="op">=</span> <span class="st">'dedup_key'</span>,</span>
<span>  group_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"id"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span><span class="op">[</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Filter to pull out just CIMS data</span></span>
<span><span class="va">lnk.grouped_cims</span> <span class="op">&lt;-</span> <span class="va">lnk.dt_combined_grouped</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">data_source</span> <span class="op">==</span> <span class="st">"dt_cims"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span> <span class="op">(</span></span>
<span>    <span class="va">id</span>,</span>
<span>    <span class="va">Case_identifier</span>,</span>
<span>    <span class="va">date_of_birth</span>,</span>
<span>    <span class="va">forename</span>,</span>
<span>    <span class="va">surname</span>,</span>
<span>    <span class="va">nhsnumber</span>,</span>
<span>    <span class="va">postcode</span>,</span>
<span>    <span class="va">Infection</span>,</span>
<span>    <span class="va">sex</span>,</span>
<span>    <span class="va">common_date</span>,</span>
<span>    <span class="va">data_source</span>,</span>
<span>    <span class="va">dedup_key</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Filter to pull out just SGSS data</span></span>
<span><span class="va">lnk.grouped_sgss</span> <span class="op">&lt;-</span> <span class="va">lnk.dt_combined_grouped</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">data_source</span> <span class="op">==</span> <span class="st">"dt_sgss"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">select</span> <span class="op">(</span></span>
<span>    <span class="va">CDR_OPIE_ID</span>,</span>
<span>    <span class="va">id</span>,</span>
<span>    <span class="va">date_of_birth</span>,</span>
<span>    <span class="va">forename</span>,</span>
<span>    <span class="va">surname</span>,</span>
<span>    <span class="va">nhsnumber</span>,</span>
<span>    <span class="va">postcode</span>,</span>
<span>    <span class="va">GROUP_A_STREP_PCR</span>,</span>
<span>    <span class="va">common_date</span>,</span>
<span>    <span class="va">data_source</span>,</span>
<span>    <span class="va">dedup_key</span>,</span>
<span>    <span class="va">third</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Taking one row from each split - gives one episode per dataset</span></span>
<span><span class="va">lnk.grouped_cims_deduped</span> <span class="op">&lt;-</span> <span class="va">lnk.grouped_cims</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">dedup_key</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">slice</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># De-duplicating SGSS- prioritising earliest emm typing with a relevant result</span></span>
<span><span class="va">lnk.grouped_sgss_deduped</span> <span class="op">&lt;-</span> <span class="va">lnk.grouped_sgss</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">dedup_key</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="va">dedup_key</span>, <span class="va">common_date</span><span class="op">)</span> <span class="op">|&gt;</span>   </span>
<span>  <span class="fu">slice</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># Join splits by dedup key- common field names with .x refer to CIMS and .y for SGSS</span></span>
<span><span class="va">lnk.split_join_cims_sgss</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">full_join</span><span class="op">(</span><span class="va">lnk.grouped_cims_deduped</span>, <span class="va">lnk.grouped_sgss_deduped</span>, by <span class="op">=</span> <span class="st">"dedup_key"</span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Alex Bhattacharya, Alice Graham, Harshana Liyanage, Frederick Sloots, Emma Parker.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
